<!DOCTYPE html>
<html lang="en-us">
<head>
    <title>Chess Tutor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --backgroundColor: hsl(0, 0%, 25%);
            --squareWhiteColor: hsl(37, 63%, 81%);
            --squareBlackColor: hsl(26, 38%, 55%);
            --squareWhiteSelectedColor: hsl(55, 87%, 70%);
            --squareBlackSelectedColor: hsl(50, 67%, 58%);
        }
        body {
            touch-action: none;
            overflow: hidden;
            margin: 0px;
            background-color: var(--backgroundColor);
        }
        #boardArea {
            width: 100vw;
            height: 100vh;
        }
        #board {
            aspect-ratio: 1;
            margin: auto;
            max-height: 100%;
            display: grid;
            grid-template-columns: auto auto auto auto auto auto auto auto;
            caret-color: transparent;
        }
        .squareWhite {
            position: relative;
            background-color: var(--squareWhiteColor);
        }
        .squareBlack {
            position: relative;
            background-color: var(--squareBlackColor);
        }
        .piece {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: grab;
        }
    </style>
</head>
<body>
    <svg display="none">
        <symbol id="piece_K" viewBox="0 0 45 45" style="fill:none; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
            d="M 22.5,11.63 L 22.5,6"
            style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
            <path
            d="M 20,8 L 25,8"
            style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
            <path
            d="M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25"
            style="fill:#ffffff; stroke:#000000; stroke-linecap:butt; stroke-linejoin:miter;" />
            <path
            d="M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z "
            style="fill:#ffffff; stroke:#000000;" />
            <path
            d="M 11.5,30 C 17,27 27,27 32.5,30"
            style="fill:none; stroke:#000000;" />
            <path
            d="M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5"
            style="fill:none; stroke:#000000;" />
            <path
            d="M 11.5,37 C 17,34 27,34 32.5,37"
            style="fill:none; stroke:#000000;" />
        </symbol>    
        <symbol id="piece_Q" viewBox="0 0 45 45" style="opacity:1; fill:#ffffff; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
            d="M 9 13 A 2 2 0 1 1  5,13 A 2 2 0 1 1  9 13 z"
            transform="translate(-1,-1)" />
            <path
            d="M 9 13 A 2 2 0 1 1  5,13 A 2 2 0 1 1  9 13 z"
            transform="translate(15.5,-5.5)" />
            <path
            d="M 9 13 A 2 2 0 1 1  5,13 A 2 2 0 1 1  9 13 z"
            transform="translate(32,-1)" />
            <path
            d="M 9 13 A 2 2 0 1 1  5,13 A 2 2 0 1 1  9 13 z"
            transform="translate(7,-4.5)" />
            <path
            d="M 9 13 A 2 2 0 1 1  5,13 A 2 2 0 1 1  9 13 z"
            transform="translate(24,-4)" />
            <path
            d="M 9,26 C 17.5,24.5 30,24.5 36,26 L 38,14 L 31,25 L 31,11 L 25.5,24.5 L 22.5,9.5 L 19.5,24.5 L 14,10.5 L 14,25 L 7,14 L 9,26 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 11.5,30 C 15,29 30,29 33.5,30"
            style="fill:none;" />
            <path
            d="M 12,33.5 C 18,32.5 27,32.5 33,33.5"
            style="fill:none;" />
        </symbol>
        <symbol id="piece_B" viewBox="0 0 45 45" style="opacity:1; fill:none; fill-rule:evenodd; fill-opacity:1; stroke:#000000; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <g style="fill:#ffffff; stroke:#000000; stroke-linecap:butt;"> 
                <path
                d="M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z" />
                <path
                d="M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z" />
                <path
                d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z" />
            </g>
            <path
            d="M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 22.5,15.5 L 22.5,20.5 M 20,18 L 25,18"
            style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
        </symbol>
        <symbol id="piece_N" viewBox="0 0 45 45" style="opacity:1; fill:none; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
            d="M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18"
            style="fill:#ffffff; stroke:#000000;" />
            <path
            d="M 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10"
            style="fill:#ffffff; stroke:#000000;" />
            <path
            d="M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z"
            style="fill:#000000; stroke:#000000;" />
            <path
            d="M 15 15.5 A 0.5 1.5 0 1 1  14,15.5 A 0.5 1.5 0 1 1  15 15.5 z"
            transform="matrix(0.866,0.5,-0.5,0.866,9.693,-5.173)"
            style="fill:#000000; stroke:#000000;" />
        </symbol>
        <symbol id="piece_R" viewBox="0 0 45 45" style="opacity:1; fill:#ffffff; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
            d="M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14"
            style="stroke-linecap:butt;" />
            <path
            d="M 34,14 L 31,17 L 14,17 L 11,14" />
            <path
            d="M 31,17 L 31,29.5 L 14,29.5 L 14,17"
            style="stroke-linecap:butt; stroke-linejoin:miter;" />
            <path
            d="M 31,29.5 L 32.5,32 L 12.5,32 L 14,29.5" />
            <path
            d="M 11,14 L 34,14"
            style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
        </symbol>
        <symbol id="piece_P" viewBox="0 0 45 45">
            <path
            d="M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z "
            style="opacity:1; fill:#ffffff; fill-opacity:1; fill-rule:nonzero; stroke:#000000; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:miter; stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;" />
        </symbol>
        <symbol id="piece_k" viewBox="0 0 45 45" style="fill:none; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path 
                d="M 22.5,11.63 L 22.5,6"
                style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
            <path
                d="M 22.5,25 C 22.5,25 27,17.5 25.5,14.5 C 25.5,14.5 24.5,12 22.5,12 C 20.5,12 19.5,14.5 19.5,14.5 C 18,17.5 22.5,25 22.5,25" 
                style="fill:#000000;fill-opacity:1; stroke-linecap:butt; stroke-linejoin:miter;" />
            <path
               d="M 11.5,37 C 17,40.5 27,40.5 32.5,37 L 32.5,30 C 32.5,30 41.5,25.5 38.5,19.5 C 34.5,13 25,16 22.5,23.5 L 22.5,27 L 22.5,23.5 C 19,16 9.5,13 6.5,19.5 C 3.5,25.5 11.5,29.5 11.5,29.5 L 11.5,37 z "
               style="fill:#000000; stroke:#000000;" />
            <path
               d="M 20,8 L 25,8"
               style="fill:none; stroke:#000000; stroke-linejoin:miter;" />
            <path
               d="M 32,29.5 C 32,29.5 40.5,25.5 38.03,19.85 C 34.15,14 25,18 22.5,24.5 L 22.51,26.6 L 22.5,24.5 C 20,18 9.906,14 6.997,19.85 C 4.5,25.5 11.85,28.85 11.85,28.85"
               style="fill:none; stroke:#ffffff;" />
            <path
               d="M 11.5,30 C 17,27 27,27 32.5,30 M 11.5,33.5 C 17,30.5 27,30.5 32.5,33.5 M 11.5,37 C 17,34 27,34 32.5,37"
               style="fill:none; stroke:#ffffff;" />
        </symbol>
        <symbol id="piece_q" viewBox="0 0 45 45" style="opacity:1; fill:000000; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <g style="fill:#000000; stroke:none;">
                <circle cx="6"    cy="12" r="2.75" />
                <circle cx="14"   cy="9"  r="2.75" />
                <circle cx="22.5" cy="8"  r="2.75" />
                <circle cx="31"   cy="9"  r="2.75" />
                <circle cx="39"   cy="12" r="2.75" />
            </g>
            <path
            d="M 9,26 C 17.5,24.5 30,24.5 36,26 L 38.5,13.5 L 31,25 L 30.7,10.9 L 25.5,24.5 L 22.5,10 L 19.5,24.5 L 14.3,10.9 L 14,25 L 6.5,13.5 L 9,26 z"
            style="stroke-linecap:butt; stroke:#000000;" />
            <path
            d="M 9,26 C 9,28 10.5,28 11.5,30 C 12.5,31.5 12.5,31 12,33.5 C 10.5,34.5 10.5,36 10.5,36 C 9,37.5 11,38.5 11,38.5 C 17.5,39.5 27.5,39.5 34,38.5 C 34,38.5 35.5,37.5 34,36 C 34,36 34.5,34.5 33,33.5 C 32.5,31 32.5,31.5 33.5,30 C 34.5,28 36,28 36,26 C 27.5,24.5 17.5,24.5 9,26 z"
            style="stroke-linecap:butt;" />
            <path
            d="M 11,38.5 A 35,35 1 0 0 34,38.5"
            style="fill:none; stroke:#000000; stroke-linecap:butt;" />
            <path
            d="M 11,29 A 35,35 1 0 1 34,29"
            style="fill:none; stroke:#ffffff;" />
            <path
            d="M 12.5,31.5 L 32.5,31.5"
            style="fill:none; stroke:#ffffff;" />
            <path
            d="M 11.5,34.5 A 35,35 1 0 0 33.5,34.5"
            style="fill:none; stroke:#ffffff;" />
            <path
            d="M 10.5,37.5 A 35,35 1 0 0 34.5,37.5"
            style="fill:none; stroke:#ffffff;" />
        </symbol>
        <symbol id="piece_b" viewBox="0 0 45 45" style="opacity:1; fill:none; fill-rule:evenodd; fill-opacity:1; stroke:#000000; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:round; stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <g style="fill:#000000; stroke:#000000; stroke-linecap:butt;"> 
                <path
                    d="M 9,36 C 12.39,35.03 19.11,36.43 22.5,34 C 25.89,36.43 32.61,35.03 36,36 C 36,36 37.65,36.54 39,38 C 38.32,38.97 37.35,38.99 36,38.5 C 32.61,37.53 25.89,38.96 22.5,37.5 C 19.11,38.96 12.39,37.53 9,38.5 C 7.646,38.99 6.677,38.97 6,38 C 7.354,36.06 9,36 9,36 z" />
                <path
                    d="M 15,32 C 17.5,34.5 27.5,34.5 30,32 C 30.5,30.5 30,30 30,30 C 30,27.5 27.5,26 27.5,26 C 33,24.5 33.5,14.5 22.5,10.5 C 11.5,14.5 12,24.5 17.5,26 C 17.5,26 15,27.5 15,30 C 15,30 14.5,30.5 15,32 z" />
                <path
                    d="M 25 8 A 2.5 2.5 0 1 1  20,8 A 2.5 2.5 0 1 1  25 8 z" />
            </g>
            <path
               d="M 17.5,26 L 27.5,26 M 15,30 L 30,30 M 22.5,15.5 L 22.5,20.5 M 20,18 L 25,18"
               style="fill:none; stroke:#ffffff; stroke-linejoin:miter;" />
        </symbol>
        <symbol id="piece_n" viewBox="0 0 45 45" style="opacity:1; fill:none; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
               d="M 22,10 C 32.5,11 38.5,18 38,39 L 15,39 C 15,30 25,32.5 23,18"
               style="fill:#000000; stroke:#000000;" />
            <path
               d="M 24,18 C 24.38,20.91 18.45,25.37 16,27 C 13,29 13.18,31.34 11,31 C 9.958,30.06 12.41,27.96 11,28 C 10,28 11.19,29.23 10,30 C 9,30 5.997,31 6,26 C 6,24 12,14 12,14 C 12,14 13.89,12.1 14,10.5 C 13.27,9.506 13.5,8.5 13.5,7.5 C 14.5,6.5 16.5,10 16.5,10 L 18.5,10 C 18.5,10 19.28,8.008 21,7 C 22,7 22,10 22,10"
               style="fill:#000000; stroke:#000000;" />
            <path
               d="M 9.5 25.5 A 0.5 0.5 0 1 1 8.5,25.5 A 0.5 0.5 0 1 1 9.5 25.5 z"
               style="fill:#ffffff; stroke:#ffffff;" />
            <path
               d="M 15 15.5 A 0.5 1.5 0 1 1  14,15.5 A 0.5 1.5 0 1 1  15 15.5 z"
               transform="matrix(0.866,0.5,-0.5,0.866,9.693,-5.173)"
               style="fill:#ffffff; stroke:#ffffff;" />
            <path
               d="M 24.55,10.4 L 24.1,11.85 L 24.6,12 C 27.75,13 30.25,14.49 32.5,18.75 C 34.75,23.01 35.75,29.06 35.25,39 L 35.2,39.5 L 37.45,39.5 L 37.5,39 C 38,28.94 36.62,22.15 34.25,17.66 C 31.88,13.17 28.46,11.02 25.06,10.5 L 24.55,10.4 z "
               style="fill:#ffffff; stroke:none;" />
        </symbol>
        <symbol id="piece_r" viewBox="0 0 45 45" style="opacity:1; fill:000000; fill-opacity:1; fill-rule:evenodd; stroke:#000000; stroke-width:1.5; stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;">
            <path
            d="M 9,39 L 36,39 L 36,36 L 9,36 L 9,39 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 12.5,32 L 14,29.5 L 31,29.5 L 32.5,32 L 12.5,32 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 12,36 L 12,32 L 33,32 L 33,36 L 12,36 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 14,29.5 L 14,16.5 L 31,16.5 L 31,29.5 L 14,29.5 z "
            style="stroke-linecap:butt;stroke-linejoin:miter;" />
            <path
            d="M 14,16.5 L 11,14 L 34,14 L 31,16.5 L 14,16.5 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 11,14 L 11,9 L 15,9 L 15,11 L 20,11 L 20,9 L 25,9 L 25,11 L 30,11 L 30,9 L 34,9 L 34,14 L 11,14 z "
            style="stroke-linecap:butt;" />
            <path
            d="M 12,35.5 L 33,35.5 L 33,35.5"
            style="fill:none; stroke:#ffffff; stroke-width:1; stroke-linejoin:miter;" />
            <path
            d="M 13,31.5 L 32,31.5"
            style="fill:none; stroke:#ffffff; stroke-width:1; stroke-linejoin:miter;" />
            <path
            d="M 14,29.5 L 31,29.5"
            style="fill:none; stroke:#ffffff; stroke-width:1; stroke-linejoin:miter;" />
            <path
            d="M 14,16.5 L 31,16.5"
            style="fill:none; stroke:#ffffff; stroke-width:1; stroke-linejoin:miter;" />
            <path
            d="M 11,14 L 34,14"
            style="fill:none; stroke:#ffffff; stroke-width:1; stroke-linejoin:miter;" />
        </symbol>
        <symbol id="piece_p" viewBox="0 0 45 45">
            <path
            d="M 22,9 C 19.79,9 18,10.79 18,13 C 18,13.89 18.29,14.71 18.78,15.38 C 16.83,16.5 15.5,18.59 15.5,21 C 15.5,23.03 16.44,24.84 17.91,26.03 C 14.91,27.09 10.5,31.58 10.5,39.5 L 33.5,39.5 C 33.5,31.58 29.09,27.09 26.09,26.03 C 27.56,24.84 28.5,23.03 28.5,21 C 28.5,18.59 27.17,16.5 25.22,15.38 C 25.71,14.71 26,13.89 26,13 C 26,10.79 24.21,9 22,9 z "
            style="opacity:1; fill:#000000; fill-opacity:1; fill-rule:nonzero; stroke:#000000; stroke-width:1.5; stroke-linecap:round; stroke-linejoin:miter; stroke-miterlimit:4; stroke-dasharray:none; stroke-opacity:1;" />
        </symbol>
    </svg>
    <script>
        "use strict";

        class Piece {
            constructor(type) {
                this.type = type;
                this.moved = false;
            }

            isBlack() {
                return (this.type === this.type.toLowerCase());
            }

            getBasicMoves(capture = false) {
                switch (this.type) {
                    case "K": case "k":
                        return { steps: [[0, 1], [-1, 1], [-1, 0], [-1, -1], [0, -1], [1, -1], [1, 0], [1, 1]], maxSteps: 1 };
                    case "Q": case "q":
                        return { steps: [[0, 1], [-1, 1], [-1, 0], [-1, -1], [0, -1], [1, -1], [1, 0], [1, 1]], maxSteps: 8 - 1 };
                    case "R": case "r":
                        return { steps: [[0, 1], [-1, 0], [0, -1], [1, 0]], maxSteps: 8 - 1 };
                    case "B": case "b":
                        return { steps: [[-1, 1], [-1, -1], [1, -1], [1, 1]], maxSteps: 8 - 1 };
                    case "N": case "n":
                        return { steps: [[-1, 2], [-2, 1], [-2, -1], [-1, -2], [1, -2], [2, -1], [2, 1], [1, 2]], maxSteps: 1 };
                    case "P":
                        return { steps: capture ? [[-1, 1], [1, 1]] : [[0, 1]], maxSteps: (this.moved || capture) ? 1 : 2 };
                    case "p":
                        return { steps: capture ? [[1, -1], [-1, -1]] : [[0, -1]], maxSteps: (this.moved || capture) ? 1 : 2 };
                    default:
                        return null;
                }
            }
        }

        class Board {
            constructor() {
                this.squares = [];
                for (let i = 0; i < 8*8; ++i)
                    this.squares.push(null);
                this.enPassantPawnSquareId = null;
            }

            movePiece(squareId, toSquareId, testOnly = false, allowCheck = false, allowCastling = true, allowEnPassant = true) {
                if (squareId === toSquareId)
                    return null; // can't move to same square
                const squareX = Board.squareIdToX(squareId);
                const squareY = Board.squareIdToY(squareId);
                const toSquareX = Board.squareIdToX(toSquareId);
                const toSquareY = Board.squareIdToY(toSquareId);
                const piece = this.squares[Board.squareXyToIndex(squareX, squareY)];
                if (piece === null)
                    return null; // no piece to move
                const toPiece = this.squares[Board.squareXyToIndex(toSquareX, toSquareY)];
                if ((toPiece !== null) && (piece.isBlack() === toPiece.isBlack()))
                    return null; // can't move to square with same color piece
                if (allowCastling && ((piece.type === "K") || (piece.type === "k")) && (Math.abs(toSquareX - squareX) === 2) && (toSquareY === squareY)) {
                    if (piece.moved)
                        return null; // can't castle because king already moved
                    const dSquareX = toSquareX - squareX;
                    const rookSquareX = (dSquareX < 0) ? 0 : 7;
                    const rookPiece = this.squares[Board.squareXyToIndex(rookSquareX, squareY)];
                    if ((rookPiece === null) || (rookPiece.type !== ((piece.type === "k") ? "r" : "R")))
                        return null; // can't castle because no rook at edge of board
                    if (rookPiece.moved)
                        return null; // can't castle because rook already moved
                    for (let x = Math.min(squareX, rookSquareX) + 1, x1 = Math.max(squareX, rookSquareX) - 1; x <= x1; ++x) {
                        if (this.squares[Board.squareXyToIndex(x, squareY)] !== null)
                            return null; // can't castle because pieces in the way
                    }
                    if (this.getAttackers(squareId).length !== 0)
                        return null; // can't castle because king is in check
                    for (let x = (dSquareX < 0) ? toSquareX : (squareX + 1), x1 = (dSquareX < 0) ? (squareX - 1) : toSquareX; x <= x1; ++x) {
                        const attackers = this.getAttackers(Board.squareXyToId(x, squareY));
                        for (const attacker of attackers) {
                            if (this.squares[Board.squareIdToIndex(attacker)].isBlack() !== piece.isBlack())
                                return null; // can't castle because one or more target squares are in check
                        }
                    }
                    const toRookSquareX = (dSquareX < 0) ? (toSquareX + 1) : (toSquareX - 1);
                    if (!testOnly) {
                        this.squares[Board.squareXyToIndex(squareX, squareY)] = null;
                        this.squares[Board.squareXyToIndex(toSquareX, squareY)] = piece;
                        piece.moved = true;
                        this.squares[Board.squareXyToIndex(rookSquareX, squareY)] = null;
                        this.squares[Board.squareXyToIndex(toRookSquareX, squareY)] = rookPiece;
                        rookPiece.moved = true;
                        this.enPassantPawnSquareId = null;
                    }
                    return [{id: toSquareId, fromId: squareId}, {id: Board.squareXyToId(toRookSquareX, squareY), fromId: Board.squareXyToId(rookSquareX, squareY)}];
                }
                if (allowEnPassant && ((piece.type === "P") || (piece.type === "p")) && (this.enPassantPawnSquareId !== null)) {
                    const enPassantPawnSquareX = Board.squareIdToX(this.enPassantPawnSquareId);
                    const enPassantPawnSquareY = Board.squareIdToY(this.enPassantPawnSquareId);
                    const enPassantPawn = this.squares[Board.squareXyToIndex(enPassantPawnSquareX, enPassantPawnSquareY)];
                    if ((piece.isBlack() !== enPassantPawn.isBlack()) && ((squareX === (enPassantPawnSquareX - 1)) || (squareX === (enPassantPawnSquareX + 1))) && (toSquareX === enPassantPawnSquareX) && (toSquareY === (enPassantPawnSquareY + (enPassantPawn.isBlack() ? 1 : -1)))) {
                        if (!allowCheck) {
                            this.squares[Board.squareXyToIndex(squareX, squareY)] = null;
                            this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = piece;
                            this.squares[Board.squareXyToIndex(enPassantPawnSquareX, enPassantPawnSquareY)] = null;
                            const inCheck = this.isInCheck(piece.isBlack());
                            this.squares[Board.squareXyToIndex(enPassantPawnSquareX, enPassantPawnSquareY)] = enPassantPawn;
                            this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = null;
                            this.squares[Board.squareXyToIndex(squareX, squareY)] = piece;
                            if (inCheck)
                                return null; // move causes check
                        }
                        const enPassantPawnSquareId = this.enPassantPawnSquareId;
                        if (!testOnly) {
                            this.squares[Board.squareXyToIndex(squareX, squareY)] = null;
                            this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = piece;
                            this.squares[Board.squareXyToIndex(enPassantPawnSquareX, enPassantPawnSquareY)] = null;
                            piece.moved = true;
                            this.enPassantPawnSquareId = null;
                        }
                        return [{id: toSquareId, fromId: squareId}, {id: enPassantPawnSquareId, fromId: enPassantPawnSquareId}];
                    }
                }
                let valid = false;
                const basicMoves = piece.getBasicMoves(toPiece !== null);
                for (const basicSteps of basicMoves.steps) {
                    let pieceX = squareX;
                    let pieceY = squareY;
                    for (let step = 1; step <= basicMoves.maxSteps; ++step) {
                        pieceX += basicSteps[0];
                        pieceY += basicSteps[1];
                        if ((pieceX === toSquareX) && (pieceY === toSquareY)) {
                            valid = true;
                            break;
                        }
                        if ((pieceX < 0) || (pieceY < 0) || (pieceX >= 8) || (pieceY >= 8))
                            break;
                        if (this.squares[Board.squareXyToIndex(pieceX, pieceY)] !== null)
                            break;
                    }
                    if (valid)
                        break;
                }
                if (!valid)
                    return null; // not a valid basic move
                if (!allowCheck) {
                    const oldToPiece = this.squares[Board.squareXyToIndex(toSquareX, toSquareY)];
                    this.squares[Board.squareXyToIndex(squareX, squareY)] = null;
                    this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = piece;
                    const inCheck = this.isInCheck(piece.isBlack());
                    this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = oldToPiece;
                    this.squares[Board.squareXyToIndex(squareX, squareY)] = piece;
                    if (inCheck)
                        return null; // move causes check
                }
                if (!testOnly) {
                    this.squares[Board.squareXyToIndex(squareX, squareY)] = null;
                    this.squares[Board.squareXyToIndex(toSquareX, toSquareY)] = piece;
                    piece.moved = true;
                    this.enPassantPawnSquareId = (((piece.type === "P") || (piece.type === "p")) && (toSquareX === squareX) && (Math.abs(toSquareY - squareY) == 2)) ? toSquareId : null;
                }
                return [{id: toSquareId, fromId: squareId}];
                // TODO: promotion
            }

            getAttackers(squareId, allowCheck = true) {
                const attackers = [];
                const squareX = Board.squareIdToX(squareId);
                const squareY = Board.squareIdToY(squareId);
                for (let i = 0; i < this.squares.length; ++i) {
                    const fromSquareId = Board.squareIndexToId(i);
                    if (this.movePiece(fromSquareId, squareId, true, allowCheck, false, false) !== null)
                        attackers.push(fromSquareId);
                }
                return attackers;
            }

            isInCheck(black) {
                const kingSquareIds = this.findPiece(black ? "k" : "K");
                for (const kingSquareId of kingSquareIds) {
                    if (this.getAttackers(kingSquareId).length !== 0)
                        return true;
                }
                return false;
            }

            canMoveAnyPiece(black) {
                for (let i = 0; i < this.squares.length; ++i) {
                    const piece = this.squares[i];
                    if ((piece === null) || (piece.isBlack() !== black))
                        continue;
                    const squareId = Board.squareIndexToId(i);
                    for (let j = 0; j < this.squares.length; ++j) // TODO: can reduce this significantly based on piece type
                        if (this.movePiece(squareId, Board.squareIndexToId(j), true) !== null)
                            return true;
                }
                return false;
            }

            findPiece(type) {
                const squareIds = [];
                for (let i = 0; i < this.squares.length; ++i) {
                    const square = this.squares[i];
                    if ((square !== null) && (square.type === type))
                        squareIds.push(Board.squareIndexToId(i));
                }
                return squareIds;
            }

            getPiece(squareId) {
                return this.squares[Board.squareIdToIndex(squareId)];
            }
            setPiece(squareId, piece) {
                this.squares[Board.squareIdToIndex(squareId)] = piece;
            }

            static isSquareBlack(squareId) {
                return ((Board.squareIdToX(squareId) & 1) === (Board.squareIdToY(squareId) & 1));
            }
            static isSquareWhite(squareId) {
                return !isSquareBlack;
            }

            static squareIdToX(id) {
                return id.charCodeAt(0) - "a".charCodeAt(0);
            }
            static squareIdToY(id) {
                return id.charCodeAt(1) - "1".charCodeAt(0);
            }
            static squareXyToId(x, y) {
                return String.fromCharCode("a".charCodeAt(0) + x) + String.fromCharCode("1".charCodeAt(0) + y);
            }

            static squareXyToIndex(x, y) {
                return y*8 + x;
            }
            static squareIndexToX(index) {
                return index % 8;
            }
            static squareIndexToY(index) {
                return ~~(index/8);
            }

            static squareIdToIndex(id) {
                return Board.squareXyToIndex(Board.squareIdToX(id), Board.squareIdToY(id));
            }
            static squareIndexToId(index) {
                return Board.squareXyToId(Board.squareIndexToX(index), Board.squareIndexToY(index));
            }
        }

        const board = new Board();
        board.setPiece("a1", new Piece("R"));
        board.setPiece("b1", new Piece("N"));
        board.setPiece("c1", new Piece("B"));
        board.setPiece("d1", new Piece("Q"));
        board.setPiece("e1", new Piece("K"));
        board.setPiece("f1", new Piece("B"));
        board.setPiece("g1", new Piece("N"));
        board.setPiece("h1", new Piece("R"));
        board.setPiece("a2", new Piece("P"));
        board.setPiece("b2", new Piece("P"));
        board.setPiece("c2", new Piece("P"));
        board.setPiece("d2", new Piece("P"));
        board.setPiece("e2", new Piece("P"));
        board.setPiece("f2", new Piece("P"));
        board.setPiece("g2", new Piece("P"));
        board.setPiece("h2", new Piece("P"));
        board.setPiece("a7", new Piece("p"));
        board.setPiece("b7", new Piece("p"));
        board.setPiece("c7", new Piece("p"));
        board.setPiece("d7", new Piece("p"));
        board.setPiece("e7", new Piece("p"));
        board.setPiece("f7", new Piece("p"));
        board.setPiece("g7", new Piece("p"));
        board.setPiece("h7", new Piece("p"));
        board.setPiece("a8", new Piece("r"));
        board.setPiece("b8", new Piece("n"));
        board.setPiece("c8", new Piece("b"));
        board.setPiece("d8", new Piece("q"));
        board.setPiece("e8", new Piece("k"));
        board.setPiece("f8", new Piece("b"));
        board.setPiece("g8", new Piece("n"));
        board.setPiece("h8", new Piece("r"));

        function getStyleRoot() {
            return getComputedStyle(document.documentElement);
        }

        const docBoardArea = document.createElement("div");
        docBoardArea.id = "boardArea";
        document.body.appendChild(docBoardArea);

        const docBoard = document.createElement("div");
        docBoard.id = "board";
        docBoardArea.appendChild(docBoard);

        for (let y = 0; y < 8; ++y) {
            for (let x = 0; x < 8; ++x) {
                const docSquare = document.createElement("div");
                docSquare.id = Board.squareXyToId(x, 8 - 1 - y);
                docSquare.className = "square" + (Board.isSquareBlack(docSquare.id) ? "Black" : "White");
                docBoard.appendChild(docSquare);
            }
        }

        function getSquare(docBoard, id) {
            return document.getElementById(id); // TODO: can convert id to board child index and access child directly
        }

        let movingPiece = null;

        function updateDocBoard(changedSquares = null, animate = false) {
            const updateDocSquare = function(squareId, animateFromSquareId = null) {
                const docSquare = getSquare(docBoard, squareId);
                const piece = board.getPiece(squareId);
                if (piece === null) {
                    docSquare.replaceChildren();
                    docSquare.onclick = function(e) {
                        e.preventDefault();
                        if (movingPiece === null)
                            return;
                        const fromSquare = movingPiece.parentElement;
                        fromSquare.style.backgroundColor = getStyleRoot().getPropertyValue(Board.isSquareBlack(fromSquare.id) ? "--squareBlackColor" : "--squareWhiteColor");
                        const toSquare = e.currentTarget;
                        const changedSquares = board.movePiece(fromSquare.id, toSquare.id);
                        if (changedSquares !== null)
                            updateDocBoard(changedSquares, true);
                        movingPiece = null;
                    }
                }
                else {
                    docSquare.innerHTML = "<svg class=\"piece\"><use href=\"#piece_" + piece.type + "\"/></svg>";
                    const docPiece = docSquare.lastElementChild;
                    if (animateFromSquareId !== null) {
                        const squareClientRect = docSquare.getBoundingClientRect();
                        const fromSquareClientRect = getSquare(docBoard, animateFromSquareId).getBoundingClientRect();
                        docPiece.animate([{ left: (fromSquareClientRect.x - squareClientRect.x) + "px", top: (fromSquareClientRect.y - squareClientRect.y) + "px" }, { left: 0, top: 0 }], 100);
                    }
                    docPiece.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }
                    docPiece.onpointerdown = function(e) {
                        e.preventDefault();
                        if (movingPiece !== null) {
                            const fromSquare = movingPiece.parentElement;
                            fromSquare.style.backgroundColor = getStyleRoot().getPropertyValue(Board.isSquareBlack(fromSquare.id) ? "--squareBlackColor" : "--squareWhiteColor");
                            const toSquare = e.currentTarget.parentElement;
                            movingPiece = null;
                            if (board.getPiece(fromSquare.id).isBlack() !== board.getPiece(toSquare.id).isBlack()) {
                                const changedSquares = board.movePiece(fromSquare.id, toSquare.id);
                                if (changedSquares !== null)
                                    updateDocBoard(changedSquares, true);
                                return;
                            }
                        }
                        movingPiece = e.currentTarget;
                        movingPiece.style.zIndex = 2;
                        movingPiece.style.cursor = "grabbing";
                        docBoard.onpointermove = function(e) {
                            e.preventDefault();
                            if (movingPiece === null)
                                return;
                            const fromSquareClientRect = movingPiece.parentElement.getBoundingClientRect();
                            movingPiece.style.left = (e.clientX - fromSquareClientRect.x - fromSquareClientRect.width/2) + "px";
                            movingPiece.style.top = (e.clientY - fromSquareClientRect.y - fromSquareClientRect.height/2) + "px";
                        }
                        docBoard.onpointerup = function(e) {
                            e.preventDefault();
                            docBoard.onpointermove = null;
                            docBoard.onpointerup = null;
                            if (movingPiece === null)
                                return;
                            const fromSquare = movingPiece.parentElement;
                            movingPiece.style.left = 0;
                            movingPiece.style.top = 0;
                            movingPiece.style.zIndex = 1;
                            movingPiece.style.cursor = "grab";
                            let toSquare = null;
                            for (const docSquare of docBoard.children) {
                                const docSquareClientRect = docSquare.getBoundingClientRect();
                                if ((e.clientX >= docSquareClientRect.left) && (e.clientX < docSquareClientRect.right) && (e.clientY >= docSquareClientRect.top) && (e.clientY < docSquareClientRect.bottom)) {
                                    toSquare = docSquare;
                                    break;
                                }
                            }
                            if (toSquare !== null) {
                                if (toSquare.id === fromSquare.id) {
                                    fromSquare.style.backgroundColor = getStyleRoot().getPropertyValue(Board.isSquareBlack(fromSquare.id) ? "--squareBlackSelectedColor" : "--squareWhiteSelectedColor");
                                    return;
                                }
                                const changedSquares = board.movePiece(fromSquare.id, toSquare.id);
                                if (changedSquares !== null)
                                    updateDocBoard(changedSquares);
                            }
                            movingPiece = null;
                        }
                    }
                }
            };
            if (changedSquares === null) {
                for (const docSquare of docBoard.children)
                    updateDocSquare(docSquare.id);
                return;
            }
            for (const changedSquare of changedSquares) {
                updateDocSquare(changedSquare.fromId);
                if (changedSquare.id !== changedSquare.fromId)
                    updateDocSquare(changedSquare.id, animate ? changedSquare.fromId : null);
            }
        }

        updateDocBoard();
    </script>
</body>
</html>